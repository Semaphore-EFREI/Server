FROM golang:1.23 AS build

ARG SERVICE_DIR

WORKDIR /src

# Copy all services to satisfy local replace directives across modules.
COPY services ./services

WORKDIR /src/${SERVICE_DIR}

RUN go mod download

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /out/server ./cmd/server

FROM gcr.io/distroless/static:nonroot

COPY --from=build /out/server /server

USER nonroot:nonroot

ENTRYPOINT ["/server"]
