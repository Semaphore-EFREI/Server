apiVersion: v1
kind: Namespace
metadata:
  name: semaphore

---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
  namespace: semaphore
stringData:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres

---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-database-urls
  namespace: semaphore
stringData:
  auth-identity: postgres://postgres:postgres@postgres:5432/auth_identity?sslmode=disable
  academics: postgres://postgres:postgres@postgres:5432/academics?sslmode=disable
  attendance: postgres://postgres:postgres@postgres:5432/attendance?sslmode=disable
  beacon: postgres://postgres:postgres@postgres:5432/beacon?sslmode=disable

---
apiVersion: v1
kind: Secret
metadata:
  name: redis-credentials
  namespace: semaphore
stringData:
  redis-password: your_redis_password

---
apiVersion: v1
kind: Secret
metadata:
  name: jwt-secrets
  namespace: semaphore
stringData:
  jwt-private-key: change-me-jwt-private-key
  jwt-public-key: change-me-jwt-public-key
  jwt-issuer: semaphore-auth-identity

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init-sql
  namespace: semaphore
data:
  init-dbs.sql: |
    CREATE DATABASE auth_identity;
    CREATE DATABASE academics;
    CREATE DATABASE attendance;
    CREATE DATABASE beacon;

---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-init
  namespace: semaphore
spec:
  backoffLimit: 3
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: postgres:16
          command: ["sh", "-c"]
          args:
            - |
              until pg_isready -h postgres -U postgres; do
                sleep 1
              done
              psql -h postgres -U postgres -f /scripts/init-dbs.sql
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_PASSWORD
          volumeMounts:
            - name: init-script
              mountPath: /scripts
      volumes:
        - name: init-script
          configMap:
            name: db-init-sql

---
apiVersion: batch/v1
kind: Job
metadata:
  name: semaphore-migrations
  namespace: semaphore
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-postgres
          image: postgres:16
          command: ["sh", "-c"]
          args:
            - |
              until pg_isready -h postgres -U postgres; do
                sleep 1
              done
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_PASSWORD
      containers:
        - name: migrate
          image: registry.burrito.deway.fr/semaphore-migrations:latest
          imagePullPolicy: Always
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              migrate -path /migrations/auth_identity -database "${AUTH_IDENTITY_DATABASE_URL}" up
              migrate -path /migrations/academics -database "${ACADEMICS_DATABASE_URL}" up
              migrate -path /migrations/attendance -database "${ATTENDANCE_DATABASE_URL}" up
              migrate -path /migrations/beacon -database "${BEACON_DATABASE_URL}" up
          env:
            - name: AUTH_IDENTITY_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: auth-identity
            - name: ACADEMICS_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: academics
            - name: ATTENDANCE_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: attendance
            - name: BEACON_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: beacon

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: semaphore
  labels:
    app: postgres
spec:
  selector:
    app: postgres
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: semaphore
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: postgres
          ports:
            - containerPort: 5432
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: semaphore
  labels:
    app: redis
spec:
  selector:
    app: redis
  ports:
    - name: redis
      port: 6379
      targetPort: 6379

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: semaphore
spec:
  serviceName: redis
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7
          command:
            - sh
            - -c
            - |
              redis-server --requirepass "$REDIS_PASSWORD"
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: redis-password
          ports:
            - containerPort: 6379
              name: redis
          volumeMounts:
            - name: data
              mountPath: /data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-identity
  namespace: semaphore
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth-identity
  template:
    metadata:
      labels:
        app: auth-identity
    spec:
      containers:
        - name: auth-identity
          image: registry.burrito.deway.fr/semaphore-auth-identity:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8081
            - name: grpc
              containerPort: 9091
          env:
            - name: HTTP_ADDR
              value: ":8081"
            - name: GRPC_ADDR
              value: ":9091"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: auth-identity
            - name: JWT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-private-key
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-public-key
            - name: JWT_ISSUER
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-issuer
            - name: REDIS_ADDR
              value: redis:6379
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: redis-password
          readinessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 15
            periodSeconds: 20

---
apiVersion: v1
kind: Service
metadata:
  name: auth-identity
  namespace: semaphore
  labels:
    app: auth-identity
spec:
  selector:
    app: auth-identity
  ports:
    - name: http
      port: 8081
      targetPort: 8081
    - name: grpc
      port: 9091
      targetPort: 9091

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: academics
  namespace: semaphore
spec:
  replicas: 2
  selector:
    matchLabels:
      app: academics
  template:
    metadata:
      labels:
        app: academics
    spec:
      containers:
        - name: academics
          image: registry.burrito.deway.fr/semaphore-academics:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8082
            - name: grpc
              containerPort: 9092
          env:
            - name: HTTP_ADDR
              value: ":8082"
            - name: GRPC_ADDR
              value: ":9092"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: academics
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-public-key
            - name: JWT_ISSUER
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-issuer
            - name: REDIS_ADDR
              value: redis:6379
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: redis-password
          readinessProbe:
            httpGet:
              path: /health
              port: 8082
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8082
            initialDelaySeconds: 15
            periodSeconds: 20

---
apiVersion: v1
kind: Service
metadata:
  name: academics
  namespace: semaphore
  labels:
    app: academics
spec:
  selector:
    app: academics
  ports:
    - name: http
      port: 8082
      targetPort: 8082
    - name: grpc
      port: 9092
      targetPort: 9092

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: attendance
  namespace: semaphore
spec:
  replicas: 2
  selector:
    matchLabels:
      app: attendance
  template:
    metadata:
      labels:
        app: attendance
    spec:
      containers:
        - name: attendance
          image: registry.burrito.deway.fr/semaphore-attendance:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8083
            - name: grpc
              containerPort: 9093
          env:
            - name: HTTP_ADDR
              value: ":8083"
            - name: GRPC_ADDR
              value: ":9093"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: attendance
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-public-key
            - name: JWT_ISSUER
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-issuer
            - name: ACADEMICS_GRPC_ADDR
              value: academics:9092
            - name: IDENTITY_GRPC_ADDR
              value: auth-identity:9091
            - name: REDIS_ADDR
              value: redis:6379
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: redis-password
            - name: GRPC_DIAL_TIMEOUT
              value: 5s
            - name: BUZZLIGHTYEAR_TTL
              value: 45s
          readinessProbe:
            httpGet:
              path: /health
              port: 8083
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8083
            initialDelaySeconds: 15
            periodSeconds: 20

---
apiVersion: v1
kind: Service
metadata:
  name: attendance
  namespace: semaphore
  labels:
    app: attendance
spec:
  selector:
    app: attendance
  ports:
    - name: http
      port: 8083
      targetPort: 8083
    - name: grpc
      port: 9093
      targetPort: 9093

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: beacon
  namespace: semaphore
spec:
  replicas: 2
  selector:
    matchLabels:
      app: beacon
  template:
    metadata:
      labels:
        app: beacon
    spec:
      containers:
        - name: beacon
          image: registry.burrito.deway.fr/semaphore-beacon:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8084
          env:
            - name: HTTP_ADDR
              value: ":8084"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-database-urls
                  key: beacon
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-public-key
            - name: JWT_ISSUER
              valueFrom:
                secretKeyRef:
                  name: jwt-secrets
                  key: jwt-issuer
            - name: ATTENDANCE_GRPC_ADDR
              value: attendance:9093
            - name: REDIS_ADDR
              value: redis:6379
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: redis-password
          readinessProbe:
            httpGet:
              path: /health
              port: 8084
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8084
            initialDelaySeconds: 15
            periodSeconds: 20

---
apiVersion: v1
kind: Service
metadata:
  name: beacon
  namespace: semaphore
  labels:
    app: beacon
spec:
  selector:
    app: beacon
  ports:
    - name: http
      port: 8084
      targetPort: 8084
