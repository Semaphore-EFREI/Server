apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: semaphore-gateway
  namespace: semaphore
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - semaphore.deway.fr

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: semaphore-gateway
  namespace: semaphore
spec:
  hosts:
    - semaphore.deway.fr
  gateways:
    - semaphore-gateway
  http:
    - match:
        - uri:
            regex: ^/course/[^/]+/status$
      name: course_status
      corsPolicy: &semaphoreCors
        allowOrigins:
          - exact: "https://semaphore.lebonnec.uk"
          - exact: "https://semaphore.deway.fr"
          - exact: "http://localhost:3000"
          - exact: "http://localhost:5173"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - authorization
          - content-type
          - x-device-id
          - x-student-id
          - x-course-id
          - idempotency-key
        exposeHeaders:
          - content-length
        maxAge: 86400s
        allowCredentials: true
      headers: &forwardedHeaders
        request:
          set:
            x-forwarded-proto: "https"
            x-forwarded-port: "443"
      route:
        - destination:
            host: attendance.semaphore.svc.cluster.local
            port:
              number: 8083
    - match:
        - uri:
            exact: /
      name: root
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      redirect:
        uri: /health
    - match:
        - uri:
            prefix: /health
      name: health
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /signatures
      name: signatures
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: attendance.semaphore.svc.cluster.local
            port:
              number: 8083
    - match:
        - uri:
            prefix: /signature
      name: signature
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: attendance.semaphore.svc.cluster.local
            port:
              number: 8083
    - match:
        - uri:
            prefix: /dev/beacon
      name: dev_beacon
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: beacon.semaphore.svc.cluster.local
            port:
              number: 8084
    - match:
        - uri:
            prefix: /beacon
      name: beacon
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: beacon.semaphore.svc.cluster.local
            port:
              number: 8084
    - match:
        - uri:
            prefix: /auth
      name: auth
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /users
      name: users
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /students
      name: students
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /studentGroups
      name: student_groups
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /studentGroup
      name: student_group
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /student
      name: student
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /teachers
      name: teachers
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /teacher
      name: teacher
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /admins
      name: admins
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /admin
      name: admin
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
    - match:
        - uri:
            prefix: /schools
      name: schools
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /school
      name: school
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /courses
      name: courses
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /course
      name: course
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /classrooms
      name: classrooms
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /classroom
      name: classroom
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: academics.semaphore.svc.cluster.local
            port:
              number: 8082
    - match:
        - uri:
            prefix: /.well-known
      name: jwks
      corsPolicy: *semaphoreCors
      headers: *forwardedHeaders
      route:
        - destination:
            host: auth-identity.semaphore.svc.cluster.local
            port:
              number: 8081
