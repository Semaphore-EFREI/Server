apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: semaphore-gateway
  namespace: semaphore
spec:
  filterOrder:
    - name: envoy.filters.http.cors
      before: envoy.filters.http.jwt_authn
  provider:
    type: Kubernetes
    kubernetes:
      envoyService:
        type: LoadBalancer
      envoyDeployment:
        name: envoy-semaphore-gateway
        replicas: 2
        pod:
          annotations:
            sidecar.istio.io/inject: "true"
            traffic.sidecar.istio.io/includeInboundPorts: "*"
            traffic.sidecar.istio.io/includeOutboundIPRanges: "*"
            proxy.istio.io/config: '{"proxyMetadata":{"ISTIO_META_DNS_CAPTURE":"true","ISTIO_META_DNS_AUTO_ALLOCATE":"true"}}'

---
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: semaphore-gateway
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
  parametersRef:
    group: gateway.envoyproxy.io
    kind: EnvoyProxy
    name: semaphore-gateway
    namespace: semaphore

---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: semaphore-gateway
  namespace: semaphore
spec:
  gatewayClassName: semaphore-gateway
  listeners:
    - name: http
      port: 80
      protocol: HTTP
      allowedRoutes:
        namespaces:
          from: Same

---
apiVersion: v1
kind: Service
metadata:
  name: envoy-semaphore-gateway
  namespace: envoy-gateway-system
  labels:
    app.kubernetes.io/name: envoy
    app.kubernetes.io/component: proxy
    app.kubernetes.io/managed-by: envoy-gateway
spec:
  selector:
    app.kubernetes.io/name: envoy
    app.kubernetes.io/component: proxy
    app.kubernetes.io/managed-by: envoy-gateway
  ports:
    - name: http
      port: 80
      targetPort: 10080

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: envoy-semaphore-gateway
  namespace: envoy-gateway-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: envoy-semaphore-gateway
  minReplicas: 2
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: envoy-gateway-mtls
  namespace: envoy-gateway-system
spec:
  host: "*.envoy-gateway-system.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: semaphore-auth-identity-public
  namespace: semaphore
spec:
  parentRefs:
    - name: semaphore-gateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /.well-known
        - path:
            type: PathPrefix
            value: /auth
      backendRefs:
        - name: auth-identity
          port: 8081

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: semaphore-auth-identity-protected
  namespace: semaphore
spec:
  parentRefs:
    - name: semaphore-gateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /users
        - path:
            type: PathPrefix
            value: /students
        - path:
            type: PathPrefix
            value: /student
        - path:
            type: PathPrefix
            value: /teachers
        - path:
            type: PathPrefix
            value: /teacher
        - path:
            type: PathPrefix
            value: /admins
        - path:
            type: PathPrefix
            value: /admin
      backendRefs:
        - name: auth-identity
          port: 8081

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: semaphore-academics
  namespace: semaphore
spec:
  parentRefs:
    - name: semaphore-gateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /studentGroups
        - path:
            type: PathPrefix
            value: /studentGroup
        - path:
            type: PathPrefix
            value: /schools
        - path:
            type: PathPrefix
            value: /school
        - path:
            type: PathPrefix
            value: /courses
        - path:
            type: PathPrefix
            value: /course
        - path:
            type: PathPrefix
            value: /classrooms
        - path:
            type: PathPrefix
            value: /classroom
      backendRefs:
        - name: academics
          port: 8082

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: semaphore-attendance
  namespace: semaphore
spec:
  parentRefs:
    - name: semaphore-gateway
  rules:
    - matches:
        - path:
            type: RegularExpression
            value: ^/course/[^/]+/status$
        - path:
            type: PathPrefix
            value: /signatures
        - path:
            type: PathPrefix
            value: /signature
      backendRefs:
        - name: attendance
          port: 8083

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: semaphore-beacon
  namespace: semaphore
spec:
  parentRefs:
    - name: semaphore-gateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /beacon
        - path:
            type: PathPrefix
            value: /beacons
      backendRefs:
        - name: beacon
          port: 8084

---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: semaphore-jwt-protected
  namespace: semaphore
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: semaphore-auth-identity-protected
  jwt:
    providers:
      - name: semaphore_jwt
        issuer: semaphore-auth-identity
        remoteJWKS:
          uri: http://auth-identity.semaphore.svc.cluster.local:8081/.well-known/jwks.json

---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: semaphore-jwt-academics
  namespace: semaphore
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: semaphore-academics
  jwt:
    providers:
      - name: semaphore_jwt
        issuer: semaphore-auth-identity
        remoteJWKS:
          uri: http://auth-identity.semaphore.svc.cluster.local:8081/.well-known/jwks.json

---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: semaphore-jwt-attendance
  namespace: semaphore
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: semaphore-attendance
  jwt:
    providers:
      - name: semaphore_jwt
        issuer: semaphore-auth-identity
        remoteJWKS:
          uri: http://auth-identity.semaphore.svc.cluster.local:8081/.well-known/jwks.json

---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: semaphore-jwt-beacon
  namespace: semaphore
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: semaphore-beacon
  jwt:
    optional: true
    providers:
      - name: semaphore_jwt
        issuer: semaphore-auth-identity
        remoteJWKS:
          uri: http://auth-identity.semaphore.svc.cluster.local:8081/.well-known/jwks.json
