syntax = "proto3";

package beacon.api.v1;

option go_package = "semaphore/beacon/beacon/v1;beaconv1";

message Beacon {
  string id              = 1;
  int64  serial_number   = 2;
  string classroom_id    = 3;
  string program_version = 4;
}

message ListBeaconsByClassroomRequest {
  string classroom_id = 1;
}

message ListBeaconsByClassroomResponse {
  repeated Beacon beacons = 1;
}

message AssignBeaconToClassroomRequest {
  string beacon_id = 1;
  string classroom_id = 2;
}

message AssignBeaconToClassroomResponse {}

message RemoveBeaconFromClassroomRequest {
  string beacon_id = 1;
  string classroom_id = 2;
}

message RemoveBeaconFromClassroomResponse {}

message ValidateNfcCodeRequest {
  int64 beacon_serial_number = 1;
  string totp_code = 2;
}

message ValidateNfcCodeResponse {
  bool is_valid = 1;
  string classroom_id = 2;
  string error_code = 3;
}

message ValidateBuzzLightyearProofRequest {
  int64 beacon_serial_number = 1;
  int32 code = 2;
  string signature = 3;
  string student_id = 4;
}

message ValidateBuzzLightyearProofResponse {
  bool is_valid = 1;
  string error_code = 2;
  string classroom_id = 3;
}

message GetNfcCodeRequest {
  int64 beacon_serial_number = 1;
}

message GetNfcCodeResponse {
  string totp_code = 1;
  int64 generated_at = 2;
  // Debug-only fingerprint of the decoded TOTP secret.
  string secret_fingerprint = 3;
}

// BeaconQueryService exposes read-only beacon data.
service BeaconQueryService {
  // ListBeaconsByClassroom returns all beacons assigned to a classroom.
  rpc ListBeaconsByClassroom(ListBeaconsByClassroomRequest) returns (ListBeaconsByClassroomResponse);
  // ValidateNfcCode validates a TOTP code emitted by a beacon.
  rpc ValidateNfcCode(ValidateNfcCodeRequest) returns (ValidateNfcCodeResponse);
  // ValidateBuzzLightyearProof validates a beacon-signed BuzzLightyear code.
  rpc ValidateBuzzLightyearProof(ValidateBuzzLightyearProofRequest) returns (ValidateBuzzLightyearProofResponse);
  // GetNfcCode returns the current TOTP code for a beacon (debug only).
  rpc GetNfcCode(GetNfcCodeRequest) returns (GetNfcCodeResponse);
}

// BeaconCommandService exposes write operations for beacon management.
service BeaconCommandService {
  // AssignBeaconToClassroom assigns a beacon to a classroom.
  rpc AssignBeaconToClassroom(AssignBeaconToClassroomRequest) returns (AssignBeaconToClassroomResponse);
  // RemoveBeaconFromClassroom removes a beacon from a classroom.
  rpc RemoveBeaconFromClassroom(RemoveBeaconFromClassroomRequest) returns (RemoveBeaconFromClassroomResponse);
}
